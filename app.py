import os
from dotenv import load_dotenv
from ibm_cloud_sdk_core.authenticators import IAMAuthenticator
import requests
from flask import Flask, render_template, request

# Load environment variables
load_dotenv()

app = Flask(__name__)

# Retrieve credentials
IBM_API_KEY = os.getenv("IBM_API_KEY")
IBM_URL = os.getenv("IBM_URL")

# Initialize IAM Authenticator
authenticator = IAMAuthenticator(IBM_API_KEY)

# Function to get the IAM token
def get_iam_token():
    token = authenticator.token_manager.get_token()
    return token

# IBM API call with full prompts for each task
def call_ibm_api(input_text, task):
    headers = {
        "Authorization": f"Bearer {get_iam_token()}",
        "Accept": "application/json",
        "Content-Type": "application/json"
    }

    # Define full prompts for each task
    if task == "prompt1":
        prompt_template =  f"""<s> [INST]
__grounding__

<<SYS>>

أنت مساعد لغوي متخصص في تحليل وتصحيح النصوص العربية بدقة، مع التركيز على الإعراب والقواعد النحوية وتصحيح الجمل. يُرجى الالتزام بالتوجيهات التالية في كل تحليل:

- تقديم النتائج بشكل نصي ومنسق ليسهل فهمها، بدون استخدام جداول.
- اذكر كل كلمة مع نوعها (مثل مبتدأ، خبر، فعل، إلخ)، ثم وضّح الإعراب الخاص بها.
- قدّم شرحاً دقيقاً للمواقع الإعرابية لكل عنصر.
- في حال وجود أخطاء نحوية، اذكر الخطأ وشرح السبب وكيفية تصحيحه.
- قدّم أمثلة عند الحاجة لشرح أو توضيح النقاط النحوية والإعرابية.

مثال:
العبارة: "محمد أكلت التفاحة."
الجملة الصحيحة هي: "أكل محمد التفاحة."

- الكلمة "أكل" هي فعل ماضٍ، والفاعل "محمد".
- الفاعل "محمد" مرفوع بالضمة.
- المفعول به "التفاحة" منصوب وعلامة نصبه الفتحة.

القواعد النحوية:
الفعل "أكل" هو فعل ماضٍ مبني على الفتح.
الفاعل "محمد" مرفوع وعلامة رفعه الضمة.
المفعول به "التفاحة" منصوب وعلامة نصبه الفتحة.

تصحيح الأخطاء:
في الجملة الأصلية، كان يجب أن يكون ترتيب الكلمات بحيث يظهر "محمد" كفاعل ويأتي الفعل أولاً ليصبح الفاعل هو "محمد" والمفعول به هو "التفاحة".

تحليل الجملة:
تبدأ الجملة بالفعل "أكل" الذي يعبر عن حدث ماضٍ قام به محمد. الفاعل هو "محمد" وهو مرفوع بالضمة، ويأتي بعده المفعول به "التفاحة" منصوبًا وعلامة نصبه الفتحة.

بشكل عام، الجملة الصحيحة هي: "أكل محمد التفاحة."

<</SYS>>

{input_text} [/INST]"""

    elif task == "prompt2":
        prompt_template = f"""<s> [INST]<<SYS>>
حول العبارات باللهجات السعودية إلى اللغة العربية الفصحى. كل عبارة من اللهجة السعودية يجب أن تكون متبوعة بنوع اللهجة المذكورة في الرسالة فقط، ليس كل اللهجات، مترجمة للفصحى، متبوعة بتفسير الفرق بين اللهجة السعودية والفصحى، مع توضيح للسياق المحتمل لاستخدام كل عبارة. الرد يجب أن يكون بهذه الصيغة: مثلاً لو كانت اللهجة قصيمية، سيكون الرد بصيغة "يبدو أنك تتكلم باللهجة القصيمية!" لقد حولت لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:

مثال:
اللهجة القصيمية:

العبارة: "وشوله تتعب نفسك؟"
يبدو أنك تتكلم باللهجة القصيمية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: لماذا تتعب نفسك؟
الفرق في المعنى والسياق: "وشوله" تستخدم للسؤال عن السبب، وهي مركبة من "وش" بمعنى "ماذا" و"له" بمعنى "لأجل". تُستخدم بشكل شائع في القصيم للتعبير عن عدم الجدوى.

العبارة: "وراك ما تداوم؟"
يبدو أنك تتكلم باللهجة القصيمية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: "لماذا لا تداوم؟"
الفرق في المعنى والسياق: "وراك" تُستخدم في اللهجة القصيمية بمعنى "لماذا" أو "لأي سبب". وهي تعبير مميز بالقصيم للدلالة على التساؤل.

العبارة: "أولاه نسيت مفتاح البيت!"
يبدو أنك تتكلم باللهجة القصيمية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: "لقد نسيت مفتاح المنزل!"
الفرق في المعنى والسياق: كلمة "أولاه" تُستخدم كنوع من التعجب أو إظهار الدهشة، وتدل على الاستغراب أو المفاجأة باللهجة القصيمية.

اللهجة الجنوبية:
العبارة: "وش قومك ما تداوم؟"
يبدو أنك تتكلم باللهجة الجنوبية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: "لماذا لا تداوم؟"
الفرق في المعنى والسياق: "وش قومك" تُستخدم في اللهجة الجنوبية بمعنى "لماذا" أو "لأي سبب". وهي تعبير مميز بالجنوب للدلالة على التساؤل.

اللهجة الحجازية:
العبارة: "إيش تبغى في الموضوع ده؟"
يبدو أنك تتكلم باللهجة الحجازية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: "ماذا تريد في هذا الموضوع؟"
الفرق في المعنى والسياق: "إيش" هي اختصار لـ"ما هو" باللهجة الحجازية، و"ده" تُستخدم للإشارة بمعنى "هذا". هذه التعبيرات شائعة في منطقة الحجاز.

العبارة: "ليش ماتلعبي معايا"
يبدو أنك تتكلم باللهجة الحجازية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: "لماذا لا تلعبين معي؟"
الفرق في المعنى والسياق: "ليش ماتلعبي معايا" تُستخدم في اللهجة الحجازية للتعبير عن طلب اللعب مع الشخص الآخر. في هذا السياق، تسأل العبارة عن سبب عدم اللعب مع الشخص الآخر.

اللهجة النجدية:
العبارة: "ما عندي سالفة."
يبدو أنك تتكلم باللهجة النجدية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: "ليس لدي أمر ذو أهمية."
الفرق في المعنى والسياق: "سالفة" تعني "قصة" أو "موضوع" باللهجة النجدية، وتستخدم للإشارة إلى عدم وجود أمر يستحق الذكر.

العبارة: "يا ليتني ما رحت أمس!"
يبدو أنك تتكلم باللهجة النجدية! سأساعدك لتحويل لهجتك للفصحى مع توضيح الفرق في المعنى والسياق:
الفصحى: "ليتني لم أذهب البارحة!"
الفرق في المعنى والسياق: "يا ليتني" تُستخدم في اللهجة النجدية للتمني والتعبير عن ندم بشأن حدث ما.

{input_text} [/INST]"""

    elif task == "prompt3":
        prompt_template = f"""<s> [INST]<<SYS>>
عند إدخال جملة باللهجة العامية السعودية، قم بتحويلها إلى اللغة العربية الفصحى عبر ثلاثة مستويات، بحيث يتغير كل مستوى عن الآخر بشكل واضح ويتبع التعليمات التالية:

المستوى الأول: يجب أن يكون قريبًا من العامية السعودية ولكنه مختلف بوضوح عن النص المدخل، مع تغييرات طفيفة لتحسين اللغة وإزالة التعبيرات العامية، بحيث يظهر النص بشكل أفضل من الأصل.

المستوى الثاني: فصحى معتدلة مع تعابير رسمية أكثر، ويجب أن يكون مختلفًا عن المستوى الأول، بحيث يظهر الانتقال إلى مستوى أعلى من الفصاحة.

المستوى الثالث: فصحى تامة بأسلوب لغوي رسمي، مع صياغة متقدمة تختلف بوضوح عن المستوى الثاني، بحيث يتضمن تعبيرات ومفردات فصيحة ومتقدمة.

اعرض النتيجة بالشكل التالي فقط:

المستوى الأول: [النص المحول]

المستوى الثاني: [النص المحول]

المستوى الثالث: [النص المحول]

ملاحظة إلزامية: تأكد من اختلاف كل مستوى عن الآخر بشكل واضح، خصوصًا بين المستوى الأول والنص المدخل، وبين المستوى الثاني والمستوى الثالث. يجب أن يكون المستوى الأول غير مطابق للنص المدخل، مع تغييرات كافية لجعله مختلفًا بشكل ملحوظ. بعد عرض المستويات الثلاثة، من الضروري أن تضيف الجملة التالية في النهاية كما هي تمامًا، ولن تعتبر الإجابة مكتملة بدونها: "في هذا المثال، تم تحويل النص من العامية السعودية إلى الفصحى عبر ثلاثة مستويات متدرجة. المستوى الأول احتفظ بأسلوب قريب من العامية مع بعض التحسينات، المستوى الثاني كان فصحى معتدلة، والمستوى الثالث كان فصيحًا بالكامل. تم تقديم النتائج مع عنوان المستوى لكل مرحلة، مما يوضح التدرج اللغوي بين العامية والفصحى."

{input_text} [/INST]"""

    # Construct the request body with the chosen prompt
    body = {
        "input": prompt_template,
        "model_id": "sdaia/allam-1-13b-instruct",
        "project_id": "c0280623-74ee-4342-8ded-fb85adcc87ee",
        "parameters": {
            "decoding_method": "greedy",
            "max_new_tokens": 900,
            "repetition_penalty": 1
        }
    }

    response = requests.post(
        f"{IBM_URL}/ml/v1/text/generation?version=2023-05-29",
        headers=headers,
        json=body
    )
    if response.status_code == 200:
        data = response.json()
        # Extract the generated text from the response
        generated_text = data.get("results", [{}])[0].get("generated_text", "")
        return generated_text
    else:
        return "Error: " + response.text

# Route for Prompt 1
@app.route('/prompt1', methods=['GET', 'POST'])
def prompt1():
    if request.method == 'POST':
        input_text = request.form['input_text']
        data = call_ibm_api(input_text, "prompt1")
        return render_template('prompt1.html', output=data)
    return render_template('prompt1.html')

# Route for Prompt 2
@app.route('/prompt2', methods=['GET', 'POST'])
def prompt2():
    if request.method == 'POST':
        input_text = request.form['input_text']
        data = call_ibm_api(input_text, "prompt2")
        return render_template('prompt2.html', output=data)
    return render_template('prompt2.html')

# Route for Prompt 3
@app.route('/prompt3', methods=['GET', 'POST'])
def prompt3():
    if request.method == 'POST':
        input_text = request.form['input_text']
        data = call_ibm_api(input_text, "prompt3")
        return render_template('prompt3.html', output=data)
    return render_template('prompt3.html')

# Route for Collection
@app.route('/collection')
def collection():
    return render_template('collection.html')


# Homepage route
@app.route('/')
def home():
    return render_template('home.html')

if __name__ == '__main__':
    app.run(debug=True)